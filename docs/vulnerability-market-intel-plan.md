# Vulnerability Market Intelligence Implementation Plan

## 1. Objectives
- Extend the platform's metrics so each vulnerability carries a market valuation based on exploit acquisition programs and bug bounty rewards.
- Automate scraping of public exploit price lists and bounty categories to build a historical dataset of compensation signals.
- Harmonize scraped records with the existing CVE catalog by mapping vendors/products to the normalized `cve_products` table.
- Provide analysts with pricing trend insights (min/median/max, aging), source provenance, and freshness indicators.

## 2. Data Sources & Coverage
| Program | URL | Cadence | Notes |
| --- | --- | --- | --- |
| Crowdfense Exploit Acquisition Program | https://www.crowdfense.com/exploit-acquisition-program/ | Weekly | Structured tables with iOS, Android, browser, base prices. Capture category, platform, min/max offer, submission requirements. |
| OPZero Acquisition | https://opzero.ru/en/prices/ | Weekly | Dynamic page; ensure requests respect robots. Extract product/platform, price ranges, exclusivity notes. |
| Apple Security Bounty | https://security.apple.com/bounty/categories/ | Monthly | Map categories to Apple platforms. Capture base payout, cap, escalation criteria (e.g., Lockdown Mode, persistent). |
| Microsoft Bounty Programs | https://www.microsoft.com/en-us/msrc/bounty | Monthly | Multiple sub-programs (e.g., Windows Insider, Azure). Parse program name, scope, reward ranges, prerequisites. |
| Google Android & Google Devices SRP | https://bughunters.google.com/about/rules/android-friends/6171833274204160/android-and-google-devices-security-reward-program-rules | Monthly | Nested tabs with severity tiers. Collect product family, attack surface, reward ladder. |
| Google Mobile VRP | https://bughunters.google.com/about/rules/android-friends/6618732618186752/google-mobile-vulnerability-reward-program-rules | Monthly | Similar structure; capture supported apps, tiers, bonus conditions. |
| Chrome Extensions VRP | https://bughunters.google.com/about/rules/chrome-friends/5668215344988160/chrome-extensions-vulnerability-reward-program-rules | Monthly | Extract extension categories, severity tiers, special bonuses. |
| Chrome VRP | https://bughunters.google.com/about/rules/chrome-friends/5745167867576320/chrome-vulnerability-reward-program-rules | Monthly | Includes baseline, bonus multipliers (exploits, bypasses). |
| ChromeOS VRP | https://bughunters.google.com/about/rules/chrome-friends/4919474699501568/chromeos-vulnerability-reward-program-rules | Monthly | Capture P0/P1 tiers, hardware-specific bonuses, exploitation requirements. |

*All scrapers must provide HTTP headers mimicking a standard browser, respect rate limits, and emit change logs when page structures shift.*

## 3. Data Model Extensions

### 3.1 Core Tables
```sql
-- Existing CVE products table (reference)
CREATE TABLE cve_products (
  id UUID PRIMARY KEY,
  cve_id TEXT NOT NULL,
  vendor TEXT NOT NULL,
  product TEXT NOT NULL,
  normalized_vendor TEXT NOT NULL,
  normalized_product TEXT NOT NULL
);

-- New table: market_programs
CREATE TABLE market_programs (
  id UUID PRIMARY KEY,
  slug TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  operator TEXT NOT NULL,
  program_type TEXT CHECK (program_type IN ('exploit-broker', 'bug-bounty')),
  homepage_url TEXT NOT NULL,
  scrape_frequency TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- New table: market_offers
CREATE TABLE market_offers (
  id UUID PRIMARY KEY,
  program_id UUID REFERENCES market_programs(id) ON DELETE CASCADE,
  software_key UUID REFERENCES software_catalog(id),
  cve_id TEXT, -- optional direct CVE tie-in when stated by program
  title TEXT NOT NULL,
  description TEXT,
  min_reward_usd NUMERIC,
  max_reward_usd NUMERIC,
  currency TEXT DEFAULT 'USD',
  reward_type TEXT CHECK (reward_type IN ('flat', 'range', 'bounty', 'bonus')),
  exclusivity TEXT, -- e.g., "exclusive", "non-exclusive"
  source_url TEXT NOT NULL,
  source_capture_date DATE NOT NULL,
  effective_start DATE,
  effective_end DATE,
  terms_hash TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- New table: software_catalog
CREATE TABLE software_catalog (
  id UUID PRIMARY KEY,
  vendor TEXT NOT NULL,
  product TEXT NOT NULL,
  normalized_vendor TEXT NOT NULL,
  normalized_product TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT now()
);

-- Bridge table linking market offers to CVE catalog entries
CREATE TABLE offer_cve_links (
  offer_id UUID REFERENCES market_offers(id) ON DELETE CASCADE,
  cve_product_id UUID REFERENCES cve_products(id) ON DELETE CASCADE,
  confidence SMALLINT CHECK (confidence BETWEEN 0 AND 100),
  match_method TEXT CHECK (match_method IN ('exact', 'fuzzy', 'manual-review')),
  PRIMARY KEY (offer_id, cve_product_id)
);
```

### 3.2 Supporting Tables
```sql
CREATE TABLE market_metrics (
  id UUID PRIMARY KEY,
  offer_id UUID REFERENCES market_offers(id) ON DELETE CASCADE,
  valuation_score NUMERIC NOT NULL,
  score_breakdown JSONB NOT NULL,
  computed_at TIMESTAMP DEFAULT now()
);

CREATE TABLE program_snapshots (
  id UUID PRIMARY KEY,
  program_id UUID REFERENCES market_programs(id) ON DELETE CASCADE,
  fetched_at TIMESTAMP NOT NULL,
  raw_content JSONB NOT NULL,
  parser_version TEXT NOT NULL
);
```

## 4. Scraping & Ingestion Workflow
1. **Scheduler**: Add cron jobs (Supabase Edge Function or server worker) to trigger per-program fetches based on `scrape_frequency`.
2. **Fetcher Layer**: Use `server/utils/http.ts` style helper to manage headers, caching, exponential backoff. Persist raw HTML/JSON in `program_snapshots` for replay.
3. **Parser Modules**: Create one parser per program under `server/parsers/market/`. Each exports `parse(snapshot)` returning normalized `MarketOfferDTO[]`.
4. **Normalization**:
   - Standardize currency (convert to USD using daily FX rates from existing rates service or new `exchange_rates` table).
   - Normalize vendor/product names via shared `normalizeVendorProduct()` utility (reuse logic from KEV importer).
   - Map normalized pairs to `software_catalog`, creating records when new.
   - For each normalized pair, attempt automatic linking to `cve_products` (exact match first; fallback to trigram similarity > 0.85). Flag ambiguous matches for manual review.
5. **Upsert Logic**: Use `terms_hash` (hash of relevant text, price range, scope) to dedupe. If hash changes, set `effective_end` on previous record and insert new row.
6. **Metrics Computation**:
   - Compute base `valuation_score` combining: offer value (scaled log10), exclusivity bonus, exploit requirements (from parser metadata), and recency decay.
   - Store breakdown JSON with components (`price_component`, `scope_multiplier`, `exclusivity_bonus`, `freshness_penalty`).
   - Recompute metrics nightly to account for FX and aging.
7. **Alerting**: When a market offer links to a CVE in the KEV feed, create notifications for saved filters (future use). Queue to existing alert subsystem when implemented.

## 5. Alignment with CVE Catalog
- **Software Catalog Sync**: On ingest, always attempt to find or create a `software_catalog` row using the same normalization pipeline as `cve_products`. The `normalized_vendor`/`normalized_product` columns must mirror the canonical values stored in KEV imports to keep `offer_cve_links` joinable.
- **Deterministic IDs**: Use UUID v5 derived from `(normalized_vendor, normalized_product)` to ensure cross-import stability and idempotent upserts.
- **Manual Override Tooling**: Add admin UI to confirm or adjust offer-to-CVE links when automated matching confidence < 80.
- **Backfill**: Run one-off job to pre-populate `software_catalog` with distinct vendor/product pairs from `cve_products` before first ingestion cycle.

## 6. Metrics & Analytics Enhancements
- **Valuation Dashboard**: Extend analytics page to show top-valued vulnerabilities, avg/min/max reward per vendor/product, and trend lines.
- **Risk Index**: Combine valuation score with exploitation status (KEV, Metasploit, ENSISA). Example formula:
  - `risk_index = (valuation_score * 0.6) + (exploit_presence ? 20 : 0) + (kev_listed ? 25 : 0) + (epss_percentile / 5)`.
- **Time Decay**: Apply exponential decay to valuation scores (e.g., `score *= e^{-lambda * age_days}`) to prioritize fresh offers.
- **Category Weighting**: Provide per-program multipliers (e.g., browser remote RCE gets +15, sandbox escapes +10) to highlight premium exploit classes.

## 7. Delivery Artifacts
- **Documentation**: Update `docs/` with scraper specs, schema diagrams, and onboarding instructions.
- **Database Migration**: Drizzle migrations for new tables and indexes (program slug unique, `market_offers` indexes on `(software_key)`, `(program_id, source_capture_date)`).
- **API Endpoints**: Create REST endpoints `/api/market/offers` with filters (vendor, product, CVE, program). Add aggregated metrics endpoint `/api/market/stats`.
- **UI Components**: New "Market Valuation" tab on vulnerability detail page showing linked offers, reward ranges, and program metadata.
- **QA Checklist**: Parser fixtures for each program, currency conversion unit tests, end-to-end ingestion dry run in staging DB.

## 8. Risks & Mitigations
- **HTML Structure Drift**: Mitigate with snapshot diffs and parser versioning. Alert when selectors return empty sets.
- **Currency Volatility**: Convert to USD on ingest and store original values for audit.
- **Compliance**: Respect site terms; avoid scraping content with explicit prohibitions. Provide manual upload fallback.
- **Data Quality**: Introduce `confidence` scoring and manual review queue for low-signal matches.

## 9. Timeline (T-shirt sizing)
1. Week 1: Schema migrations, software catalog backfill, normalization helpers.
2. Week 2: Build Crowdfense & OPZero scrapers, ingestion pipeline, metrics scaffolding.
3. Week 3: Implement Apple & Microsoft bounty parsers, link to metrics engine.
4. Week 4: Integrate Google VRP scrapers, unify bonus handling, finish risk index computation.
5. Week 5: API + UI exposure, QA, documentation polish.

## 10. Success Criteria
- 95% of new offers automatically mapped to existing `software_catalog` entries.
- Median time from program update to ingestion < 2 hours (after scheduler runs).
- Dashboard displays valuation metrics with drill-down to source programs.
- Alerts triggered when KEV-linked CVEs receive a new market offer.
