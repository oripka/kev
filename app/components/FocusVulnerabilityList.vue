<script setup lang="ts">
import { computed } from "vue";
import { catalogSourceBadgeMap } from "~/constants/catalogSources";
import type { KevEntrySummary } from "~/types";

const props = defineProps<{
  entries: KevEntrySummary[];
  loading: boolean;
  total: number;
  contextLabel?: string;
}>();

const numberFormatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });

const formattedVisibleCount = computed(() =>
  numberFormatter.format(props.entries.length || 0),
);

const formattedTotalCount = computed(() => numberFormatter.format(props.total || 0));

const headerTitle = computed(() => {
  const base = `${formattedVisibleCount.value} of ${formattedTotalCount.value} vulnerabilities`;
  if (props.contextLabel) {
    return `${base} associated with ${props.contextLabel}`;
  }
  return base;
});

const truncate = (value: string | null | undefined): string | null => {
  if (!value) {
    return null;
  }
  return value.length > 150 ? `${value.slice(0, 147)}…` : value;
};

const formatVendorProduct = (entry: KevEntrySummary): string | null => {
  const parts = [entry.vendor, entry.product].filter(Boolean) as string[];
  return parts.length ? parts.join(" · ") : null;
};
</script>

<template>
  <UCard>
    <template #header>
      <strong class="block text-sm font-semibold text-neutral-700 dark:text-neutral-200">
        {{ headerTitle }}
      </strong>
    </template>
    <template #default>
      <div v-if="loading" class="space-y-3">
        <USkeleton v-for="index in 6" :key="`focus-vuln-skeleton-${index}`" class="h-14 rounded-lg" />
      </div>
      <p v-else-if="!entries.length" class="text-sm text-neutral-500 dark:text-neutral-400">
        No vulnerabilities match these filters yet.
      </p>
      <ul v-else class="space-y-4">
        <li
          v-for="entry in entries"
          :key="entry.id"
          class="rounded-xl border border-neutral-200 p-4 shadow-sm transition hover:border-primary-300/80 hover:shadow-md dark:border-neutral-800 dark:hover:border-primary-400/60"
        >
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div class="space-y-1">
              <ULink
                class="text-base font-semibold text-primary-600 transition hover:text-primary-500 dark:text-primary-300"
                :href="`https://nvd.nist.gov/vuln/detail/${entry.cveId}`"
                target="_blank"
                rel="noopener noreferrer"
              >
                {{ entry.cveId }}
              </ULink>
              <p class="text-sm text-neutral-700 dark:text-neutral-200">
                {{ truncate(entry.vulnerabilityName) || "Untitled vulnerability" }}
              </p>
              <p v-if="truncate(entry.description)" class="text-xs text-neutral-500 dark:text-neutral-400">
                {{ truncate(entry.description) }}
              </p>
              <p v-if="formatVendorProduct(entry)" class="text-xs text-neutral-500 dark:text-neutral-400">
                {{ formatVendorProduct(entry) }}
              </p>
            </div>
            <div class="flex flex-col items-end gap-1 text-xs text-neutral-500 dark:text-neutral-400">
              <span v-if="entry.dateAdded">Added {{ entry.dateAdded }}</span>
              <span v-if="entry.dueDate">Due {{ entry.dueDate }}</span>
            </div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <UBadge
              v-for="source in entry.sources"
              :key="`source-${entry.id}-${source}`"
              :color="catalogSourceBadgeMap[source]?.color ?? 'neutral'"
              variant="soft"
              class="text-xs font-medium"
            >
              {{ catalogSourceBadgeMap[source]?.label ?? source.toUpperCase() }}
            </UBadge>
            <UBadge
              v-if="entry.cvssSeverity"
              color="error"
              variant="soft"
              class="text-xs font-medium"
            >
              CVSS {{ entry.cvssSeverity }}
              <span v-if="typeof entry.cvssScore === 'number'">
                · {{ entry.cvssScore.toFixed(1) }}
              </span>
            </UBadge>
            <UBadge v-if="entry.epssScore !== null" color="success" variant="soft" class="text-xs font-medium">
              EPSS {{ (entry.epssScore ?? 0).toFixed(1) }}%
            </UBadge>
            <UBadge
              v-if="entry.ransomwareUse && entry.ransomwareUse.toLowerCase().includes('known')"
              color="error"
              variant="subtle"
              class="text-xs font-medium"
            >
              Ransomware linked
            </UBadge>
          </div>
        </li>
      </ul>
    </template>
  </UCard>
</template>
